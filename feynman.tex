%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Feynman Diagrams with TikZ
% Copyright (C) 2014  Joshua Ellis
%
% Allows Feynman diagrams to be used with TikZ.
%
% Many thanks must go to Jake for his answer on tex.se upon which this is built.
% http://tex.stackexchange.com/a/87395/26980
%
% IMPORTANT:  For this to work properly, you will need to apply the following
%             patch a bug in PGF/TikZ in handling 0-sized vertices.  The patch
%             can be found at
%             https://github.com/JP-Ellis/PGF-TikZ/commit/b580a91, and it is
%             also listed below.
%
% ```
% --- a/generic/pgf/graphdrawing/lua/pgf/gd/interface/InterfaceToDisplay.lua
% +++ b/generic/pgf/graphdrawing/lua/pgf/gd/interface/InterfaceToDisplay.lua
% @@ -263,6 +263,13 @@ end
%
%  function InterfaceToDisplay.createVertex(name, shape, path, height, binding_infos, anchors)
%
% +  -- The path should never be empty, so we create a trivial path in the provided
% +  -- path is empty.  This occurs with the `coordinate` shape for example.
% +  if #path == 0 then
% +    path:appendMoveto(0, 0)
% +    path:appendClosepath()
% +  end
% +
%    -- Setup
%    local scope = InterfaceCore.topScope()
%    local binding = InterfaceCore.binding
% ```
%
%
% This LaTeX file is free: you can redistribute it and/or modify it under the
% terms of the GNU General Public License as published by the Free Software
% Foundation, either version 3 of the License, or (at your option) any later
% version.
%
% This is distributed in the hope that it will be useful, but WITHOUT ANY
% WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
% A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% HEADER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[a4paper,final]{article}
\usepackage[paperwidth=15cm, hmargin=1cm, vmargin=1cm]{geometry}
%% Graphics & Figure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{tikz,pgfplots}
\usepackage{ifluatex}
\pgfplotsset{compat=1.12}

% Set up PGF externalization
% Note that this requires the folder pgf-img to already exist
\usetikzlibrary{external}
\tikzexternalize[shell escape=-shell-escape, prefix=pgf-img/]
\tikzset{
    external/mode=list and make,
    external/system call={
        lualatex \tikzexternalcheckshellescape -halt-on-error -interaction=batchmode -jobname="\image" "\texsource" || rm "\image.pdf"},
}

% Place customizations for TikZ and PGFplots here
\usetikzlibrary{
    arrows.meta,
    decorations,
    decorations.markings,
    decorations.pathmorphing,
    graphs,
    patterns,
    shapes.geometric,
}
\ifluatex
    \usetikzlibrary{
        graphdrawing
    }
    \usegdlibrary{
        circular,
        force,
        layered,
        trees
    }
\fi

\pgfdeclaredecoration{complete sines}{initial}{
    \state{initial}[
        width=+0pt,
        next state=sine,
        persistent precomputation={
            \pgfmathsetmacro\matchinglength{
                \pgfdecoratedinputsegmentlength /
                int(\pgfdecoratedinputsegmentlength/\pgfdecorationsegmentlength)
            }
            \setlength{\pgfdecorationsegmentlength}{\matchinglength pt}
        }
    ] {}

    \state{sine}[width=\pgfdecorationsegmentlength] {
        \pgfpathsine{\pgfpoint{0.25\pgfdecorationsegmentlength}{0.5\pgfdecorationsegmentamplitude}}
        \pgfpathcosine{\pgfpoint{0.25\pgfdecorationsegmentlength}{-0.5\pgfdecorationsegmentamplitude}}
        \pgfpathsine{\pgfpoint{0.25\pgfdecorationsegmentlength}{-0.5\pgfdecorationsegmentamplitude}}
        \pgfpathcosine{\pgfpoint{0.25\pgfdecorationsegmentlength}{0.5\pgfdecorationsegmentamplitude}}
    }

    \state{final}{}
}

\tikzset{
    graphs/feynman graph/.style={
        level distance=2cm,
        sibling distance=1.5cm,
        node distance=2cm,
        spring layout,
        nodes={
            as={},
            coordinate,
        },
    },
    graphs/feynman graph'/.style={
        feynman graph,
        spring electrical layout,
    },
    graphs/layered feynman graph/.style={
        feynman graph,
        layered layout,
    },
    circled/.style={
        circle,
        draw,
        fill,
        pattern=north west lines,
        minimum size=1cm,
    },
    particle/.style={
        graphs/as={#1},
        shape=circle,
        draw=none,
    },
    % The particle styles
    photon/.style={
        decoration={
            complete sines,
            amplitude=1mm,
            segment length=2mm
        },
        decorate
    },
    fermion/.style={
        decoration={
            markings,
            mark=at position 0.5 with {
                \node[
                    transform shape,
                    xshift=-0.5mm,
                    fill=black,
                    inner sep=1pt,
                    draw,
                    isosceles triangle
                ] { };
            }m
        },
        postaction=decorate
    },
    gluon/.style={
        decoration={
            coil,
            aspect=0.75,
            mirror,
            segment length=1.5mm
        },
        decorate
    },
    % Abbreviations for the above decorations
    p/.style=photon,
    f/.style=fermion,
    g/.style=gluon,
    % For particles to bend left and right
    left/.style={
        bend left=90,
        looseness=1.5,
    },
    right/.style={
        bend right=90,
        looseness=1.75,
   },
}

% \pgfplotsset{
%
% }


\setlength{\parskip}{1cm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%     DOCUMENT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
\centering

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% CONTENT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{tikzpicture}[baseline=(a)]
  \graph [feynman graph, horizontal'=a to b]
  {
    ai -- [fermion, edge label=\(e^{-}\)] a [label=70:{\(g\)}] -- [fermion, edge label=\(e^{+}\)] af,
    a  -- [photon, edge label=\(\gamma\)] b,
    bi -- [fermion, edge label=\(e^{+}\)] b -- [fermion, edge label=\(e^{-}\)] bf;
  };
\end{tikzpicture}

\begin{tikzpicture}[baseline=(a)]
  \graph [feynman graph, horizontal'=a to b1]
  {
    ai [particle=\(e^{-}\)] -- [fermion] a -- [fermion] af [particle=\(e^{+}\)],
    a  -- [photon] b1 -- [fermion, left] b2 -- [fermion, left] b1,
    b2 -- [photon] c,
    ci [particle=\(e^{+}\)] -- [fermion] c -- [fermion] cf [particle=\(e^{-}\)];
  };
\end{tikzpicture}

\begin{tikzpicture}[baseline=(a)]
  \graph [feynman graph, horizontal=b1 to b3]
  {
    ai -- [fermion] a -- [fermion] af,
    a  -- [photon] b1,
    b3 -- [photon] c,
    ci -- [fermion] c -- [fermion] cf;
    {[edges={fermion, looseness=1}]
      b1
      -- [out=90, in=180] b2
      -- [out=0, in=90] b3
      -- [out=-90, in=0] b4
      -- [out=180, in=-90] b1,
    };
  };
  \draw[gluon] (b2) -- (b4);
\end{tikzpicture}

\begin{tikzpicture}[baseline=(e)]
  \graph [feynman graph, vertical= e to f]
  {
    a -- [fermion] b -- [photon] c -- [fermion] d,
    b -- [fermion] e -- [fermion] c,
    e -- [gluon]  f,
    h -- [fermion] f -- [fermion] i;
  };
\end{tikzpicture}

% We need a layered graph here; otherwise, the left and right vertices will
% evenly spread around the central graph.
\begin{tikzpicture}
  \graph [layered feynman graph, grow=right, edges=fermion]  {
    { a1, a2 }
    -- c [circled]
    --
    { e1, e2, e3};
  };
\end{tikzpicture}

\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
