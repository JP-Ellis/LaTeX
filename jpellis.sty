%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Joshua Ellis' own package of shortcuts
% Copyright (C) 2014  Joshua Ellis
%
% This package provides many functions which facilitate the entry of text,
% especially relating to physics.  There is no official documentation for this
% though comments throughout this file should suffice.
%
%
% This work may be distributed and/or modified under the conditions of the LaTeX
% Project Public License, either version 1.3 of this license or (at your option)
% any later version.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Joshua Ellis.
%
% This program is distributed in the hope that it will be useful, but WITHOUT
% ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
% FOR A PARTICULAR PURPOSE.  See the LaTeX Project Public License for more
% details.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{jpellis}

%% Key values
\RequirePackage{pgfopts}

%% Occasionally, some of the (re)definitions clash with other packages.  These
%% can be enabled or disabled as desired.
\newif\ifjpellis@debug
\newif\ifjpellis@theorems
\newif\ifjpellis@astrosym
\newif\ifjpellis@physics
\newif\ifjpellis@alphabets@all
\newif\ifjpellis@alphabets@bb
\newif\ifjpellis@alphabets@pzc
\newif\ifjpellis@alphabets@scr
\newif\ifjpellis@alphabets@noshort
\newif\ifjpellis@maths
\newif\ifjpellis@operators
\newif\ifjpellis@delimiters

\pgfkeys{
    /cust/.is family,
    cust,
    % /cust/.cd,
    debug/.is if=jpellis@debug,
    debug=false,
    theorems/.is if=jpellis@theorems,
    theorems=true,
    astrosym/.is if=jpellis@astrosym,
    astrosym=true,
    physics/.is if=jpellis@physics,
    physics=true,
    alphabets/.is if=jpellis@alphabets@all,
    alphabets=true,
    alphabetbb/.is if=jpellis@alphabets@bb,
    alphabetbb=true,
    alphabetpzc/.is if=jpellis@alphabets@pzc,
    alphabetpzc=true,
    alphabetscr/.is if=jpellis@alphabets@scr,
    alphabetscr=true,
    alphabetnoshort/.is if=jpellis@alphabets@noshort,
    alphabetnoshort=false,
    maths/.is if=jpellis@maths,
    maths=true,
    operators/.is if=jpellis@operators,
    operators=true,
    delimiters/.is if=jpellis@delimiters,
    delimiters=true,
}
\ProcessPgfOptions{/cust}

\ifjpellis@debug
    \typeout{------------------------------------------------------------}
    \typeout{| Debug of 'customizations' package}
    \typeout{|}
    \ifjpellis@theorems
        \typeout{| Theorems: TRUE}
    \else
        \typeout{| Theorems: FALSE}
    \fi
    \ifjpellis@astrosym
        \typeout{| Astronomical symbols: TRUE}
    \else
        \typeout{| Astronomical symbols: FALSE}
    \fi
    \ifjpellis@physics
        \typeout{| Physics short hands: TRUE}
    \else
        \typeout{| Physics short hands: FALSE}
    \fi
    \ifjpellis@alphabets@all
        \typeout{| All alphabet: TRUE}
    \else
        \typeout{| All alphabet: FALSE}
    \fi
    \ifjpellis@alphabets@pzc
        \typeout{| Alphabet 'pzc': TRUE}
    \else
        \typeout{| Alphabet 'pzc': FALSE}
    \fi
    \ifjpellis@alphabets@bb
        \typeout{| Alphabet 'bb': TRUE}
    \else
        \typeout{| Alphabet 'bb': FALSE}
    \fi
    \ifjpellis@alphabets@scr
        \typeout{| Alphabet 'scr': TRUE}
    \else
        \typeout{| Alphabet 'scr': FALSE}
    \fi
    \ifjpellis@alphabets@noshort
        \typeout{| Alphabet disable shortcuts: TRUE}
    \else
        \typeout{| Alphabet disable shortcuts: FALSE}
    \fi
    \ifjpellis@maths
        \typeout{| Maths shorthands: TRUE}
    \else
        \typeout{| Maths shorthands: FALSE}
    \fi
    \ifjpellis@operators
        \typeout{| Extra operators: TRUE}
    \else
        \typeout{| Extra operators: FALSE}
    \fi
    \ifjpellis@delimiters
        \typeout{| Extra delimiters: TRUE}
    \else
        \typeout{| Extra delimiters: FALSE}
    \fi
    \typeout{------------------------------------------------------------}
\fi

\unless\ifjpellis@alphabets@all
    \typeout{! customizations:}
    \typeout{Alphabets have been disabled.  This takes precedence over all other
    alphabet settings.}
    \typeout{}
\fi

%% The default astronomical symbols are only usable in text mode, however they
%% are quite useful as subscripts within math mode.  This redefines them so that
%% they may be used in either environment.
\ifjpellis@astrosym
    \RequirePackage[nointegrals]{wasysym}

    \let\jpellis@astrosunOld\astrosun
    \renewcommand\astrosun{\ifmmode \text{\jpellis@astrosunOld}\else \jpellis@astrosunOld\fi}
    \let\jpellis@mercuryOld\mercury
    \renewcommand\mercury{\ifmmode \text{\jpellis@mercuryOld}\else \jpellis@mercuryOld\fi}
    \let\jpellis@venusOld\venus
    \renewcommand\venus{\ifmmode \text{\jpellis@venusOld}\else \jpellis@venusOld\fi}
    \let\jpellis@earthOld\earth
    \renewcommand\earth{\ifmmode \text{\jpellis@earthOld}\else \jpellis@earthOld\fi}
    \let\jpellis@marsOld\mars
    \renewcommand\mars{\ifmmode \text{\jpellis@marsOld}\else \jpellis@marsOld\fi}
    \let\jpellis@jupiterOld\jupiter
    \renewcommand\jupiter{\ifmmode \text{\jpellis@jupiterOld}\else \jpellis@jupiterOld\fi}
    \let\jpellis@saturnOld\saturn
    \renewcommand\saturn{\ifmmode \text{\jpellis@saturnOld}\else \jpellis@saturnOld\fi}
    \let\jpellis@uranusOld\uranus
    \renewcommand\uranus{\ifmmode \text{\jpellis@uranusOld}\else \jpellis@uranusOld\fi}
    \let\jpellis@neptunOld\neptune
    \renewcommand\neptune{\ifmmode \text{\jpellis@neptunOld}\else \jpellis@neptunOld\fi}
    \let\jpellis@plutoOld\pluto
    \renewcommand\pluto{\ifmmode \text{\jpellis@plutoOld}\else \jpellis@plutoOld\fi}
\fi

%% Defines various quite a few short hands useful in physics.  These include:
%%
%% - Symbols
%%   - \emf electromotive force
%% - bra-ket functions.  These all come in starred and unstarred flavours
%%   where the starred version adjusts its size to fit the contents.
%%   - \bra{}               < |
%%   - \ket{}               | >
%%   - \braket{}{}          < | >
%%   - \brakket{}{}{}       < | | >
%%   There are also \dbraket and \dbrakket  versions which replace | with ||;
%%   and \praket and \prakket which use parentheses instead of angle brackets.
%%
%% - Feynman slash with \fsl{}
%%
%% - (Anti)-commutator.  Also in starred/unstarred flavours
%%   - \commut{}{}          [ , ]
%%   - \accommut{}{}        { , }
\ifjpellis@physics
    %% Symbols
    \newcommand{\emf}{\ensuremath{\mathcal{E}}}

    %% Bra-ket functions
    \newcommand\bra{\@ifstar
        \braStar %
        \braNoStar}
    \newcommand{\braStar}[1]{
        \left\langle #1 \right\rvert}
    \newcommand{\braNoStar}[1]{
        \langle {\textstyle #1} \rvert}

    \newcommand\ket{\@ifstar
        \ketStar %
        \ketNoStar}
    \newcommand{\ketStar}[1]{
        \left\lvert #1 \right\rangle}
    \newcommand{\ketNoStar}[1]{
        \lvert {\textstyle #1} \rangle}

    \newcommand\braket{\@ifstar
        \braketStar%
        \braketNoStar}
    \newcommand{\braketStar}[2]{
        \left\langle #1 \vphantom{#2} \!\right. %
        \left| #2 \vphantom{#1} \right\rangle}
    \newcommand{\braketNoStar}[2]{
        \langle {\textstyle #1} | {\textstyle #2} \rangle}

    \newcommand\brakket{\@ifstar
        \brakketStar%
        \brakketNoStar}
    \newcommand{\brakketStar}[3]{
        \left\langle #1 \vphantom{#2 #3} \!\right.
        \left| \vphantom{#1} #2 \vphantom{#3} \!\right.
        \left| \vphantom{#1 #2} #3 \right\rangle}
    \newcommand{\brakketNoStar}[3]{
        \langle {\textstyle #1} | {\textstyle #2} | {\textstyle #3} \rangle}

    \newcommand\praket{\@ifstar
        \praketStar%
        \praketNoStar}
    \newcommand{\praketStar}[2]{
        \left( #1 \vphantom{#2} \!\right. %
        \left| #2 \vphantom{#1} \right)}
    \newcommand{\praketNoStar}[2]{
        ( {\textstyle #1} | {\textstyle #2} )}

    \newcommand\prakket{\@ifstar
        \prakketStar%
        \prakketNoStar}
    \newcommand{\prakketStar}[3]{
        \left( #1 \vphantom{#2 #3} \!\right.
        \left| \vphantom{#1} #2 \vphantom{#3} \!\right.
        \left| \vphantom{#1 #2} #3 \right)}
    \newcommand{\prakketNoStar}[3]{
        ( {\textstyle #1} | {\textstyle #2} | {\textstyle #3} \rangle}

     \newcommand\dbraket{\@ifstar
        \dbraketStar%
        \dbraketNoStar}
    \newcommand{\dbraketStar}[2]{
        \left\langle #1 \vphantom{#2} \!\right. %
        \left\| #2 \vphantom{#1} \right\rangle}
    \newcommand{\dbraketNoStar}[2]{
        \langle {\textstyle #1} \| {\textstyle #2} \rangle}

    \newcommand\dbrakket{\@ifstar
        \dbrakketStar%
        \dbrakketNoStar}
    \newcommand{\dbrakketStar}[3]{
        \left\langle #1 \vphantom{#2 #3} \!\right.
        \left\| \vphantom{#1} #2 \vphantom{#3} \!\right.
        \left\| \vphantom{#1 #2} #3 \right\rangle}
    \newcommand{\dbrakketNoStar}[3]{
        \langle {\textstyle #1} \| {\textstyle #2} \| {\textstyle #3} \rangle}

     %% Commutator and Anticommutator
    \newcommand\commut{\@ifstar
        \commutStar%
        \commutNoStar}
    \newcommand{\commutStar}[2]{
        \left[ #1 \vphantom{#2} \!\right., %
        \left. #2 \vphantom{#1} \right]}
    \newcommand{\commutNoStar}[2]{
        [ #1 , #2 ]}
    \newcommand\acommut{\@ifstar
        \acommutStar%
        \acommutNoStar}
    \newcommand{\acommutStar}[2]{
        \left\{ #1 \vphantom{#2} \!\right., %
        \left. #2 \vphantom{#1} \right\}}
    \newcommand{\acommutNoStar}[2]{
        \{ #1 , #2 \}}

    % Feynman slash
    \RequirePackage{slashed}
    \newcommand{\fsl}[1]{\slashed{#1}}

    \newcommand{\mathsc}[1]{\textsc{#1}}
\fi

%% Define some new alphabets and also define easier ways to access them.
%% Instead of having to type \mathxyz{A}, one can more simply type \xyzA.  For
%% examples of what these alphabets look like, refer to the 'Math Alphabets' in
%% the 'Comprehensive Symbol List' (table 213, p. 68 last checked)
\ifjpellis@alphabets@all

    %% The 'pzc' alphabet is a similar to the standard calligraphic alphabet,
    %% though arguably is a little nicer.
    \ifjpellis@alphabets@pzc
        \DeclareMathAlphabet{\mathpzc}{OT1}{pzc}{m}{it}
        \unless\ifjpellis@alphabets@noshort
            \newcommand{\pzcA}{\mathpzc{A}}
            \newcommand{\pzcB}{\mathpzc{B}}
            \newcommand{\pzcC}{\mathpzc{C}}
            \newcommand{\pzcD}{\mathpzc{D}}
            \newcommand{\pzcE}{\mathpzc{E}}
            \newcommand{\pzcF}{\mathpzc{F}}
            \newcommand{\pzcG}{\mathpzc{G}}
            \newcommand{\pzcH}{\mathpzc{H}}
            \newcommand{\pzcI}{\mathpzc{I}}
            \newcommand{\pzcJ}{\mathpzc{J}}
            \newcommand{\pzcK}{\mathpzc{K}}
            \newcommand{\pzcL}{\mathpzc{L}}
            \newcommand{\pzcM}{\mathpzc{M}}
            \newcommand{\pzcN}{\mathpzc{N}}
            \newcommand{\pzcO}{\mathpzc{O}}
            \newcommand{\pzcP}{\mathpzc{P}}
            \newcommand{\pzcQ}{\mathpzc{Q}}
            \newcommand{\pzcR}{\mathpzc{R}}
            \newcommand{\pzcS}{\mathpzc{S}}
            \newcommand{\pzcT}{\mathpzc{T}}
            \newcommand{\pzcU}{\mathpzc{U}}
            \newcommand{\pzcV}{\mathpzc{V}}
            \newcommand{\pzcW}{\mathpzc{W}}
            \newcommand{\pzcX}{\mathpzc{X}}
            \newcommand{\pzcY}{\mathpzc{Y}}
            \newcommand{\pzcZ}{\mathpzc{Z}}
        \fi
    \fi

    %% The scr and scrb alphabets provide much more decorated calligraphic
    %% symbols.  The scrb is the bold variant (which unfortunately does not yet
    %% work automatically with \vt or \uv from the maths section)
    \ifjpellis@alphabets@scr
        %\RequirePackage{mathrsfs}
        \RequirePackage[scr,scaled=1.1]{rsfso}
        \unless\ifjpellis@alphabets@noshort
            \newcommand{\scrA}{\mathscr{A}}
            \newcommand{\scrB}{\mathscr{B}}
            \newcommand{\scrC}{\mathscr{C}}
            \newcommand{\scrD}{\mathscr{D}}
            \newcommand{\scrE}{\mathscr{E}}
            \newcommand{\scrF}{\mathscr{F}}
            \newcommand{\scrG}{\mathscr{G}}
            \newcommand{\scrH}{\mathscr{H}}
            \newcommand{\scrI}{\mathscr{I}}
            \newcommand{\scrJ}{\mathscr{J}}
            \newcommand{\scrK}{\mathscr{K}}
            \newcommand{\scrL}{\mathscr{L}}
            \newcommand{\scrM}{\mathscr{M}}
            \newcommand{\scrN}{\mathscr{N}}
            \newcommand{\scrO}{\mathscr{O}}
            \newcommand{\scrP}{\mathscr{P}}
            \newcommand{\scrQ}{\mathscr{Q}}
            \newcommand{\scrR}{\mathscr{R}}
            \newcommand{\scrS}{\mathscr{S}}
            \newcommand{\scrT}{\mathscr{T}}
            \newcommand{\scrU}{\mathscr{U}}
            \newcommand{\scrV}{\mathscr{V}}
            \newcommand{\scrW}{\mathscr{W}}
            \newcommand{\scrX}{\mathscr{X}}
            \newcommand{\scrY}{\mathscr{Y}}
            \newcommand{\scrZ}{\mathscr{Z}}
        \fi
    \fi

    %% The Blackboard font is the one used to denote sets of numbers (C, Z, ...)
    \ifjpellis@alphabets@bb
        \RequirePackage{amsfonts}
        \unless\ifjpellis@alphabets@noshort
            \newcommand{\bbA}{\mathbb{A}}
            \newcommand{\bbB}{\mathbb{B}}
            \newcommand{\bbC}{\mathbb{C}}
            \newcommand{\bbD}{\mathbb{D}}
            \newcommand{\bbE}{\mathbb{E}}
            \newcommand{\bbF}{\mathbb{F}}
            \newcommand{\bbG}{\mathbb{G}}
            \newcommand{\bbH}{\mathbb{H}}
            \newcommand{\bbI}{\mathbb{I}}
            \newcommand{\bbJ}{\mathbb{J}}
            \newcommand{\bbK}{\mathbb{K}}
            \newcommand{\bbL}{\mathbb{L}}
            \newcommand{\bbM}{\mathbb{M}}
            \newcommand{\bbN}{\mathbb{N}}
            \newcommand{\bbO}{\mathbb{O}}
            \newcommand{\bbP}{\mathbb{P}}
            \newcommand{\bbQ}{\mathbb{Q}}
            \newcommand{\bbR}{\mathbb{R}}
            \newcommand{\bbS}{\mathbb{S}}
            \newcommand{\bbT}{\mathbb{T}}
            \newcommand{\bbU}{\mathbb{U}}
            \newcommand{\bbV}{\mathbb{V}}
            \newcommand{\bbW}{\mathbb{W}}
            \newcommand{\bbX}{\mathbb{X}}
            \newcommand{\bbY}{\mathbb{Y}}
            \newcommand{\bbZ}{\mathbb{Z}}
        \fi
    \fi

    %% Provide the same shortcuts for the standard calligraphic and blackboard
    %% fonts.
    \unless\ifjpellis@alphabets@noshort
        \newcommand{\calA}{\mathcal{A}}
        \newcommand{\calB}{\mathcal{B}}
        \newcommand{\calC}{\mathcal{C}}
        \newcommand{\calD}{\mathcal{D}}
        \newcommand{\calE}{\mathcal{E}}
        \newcommand{\calF}{\mathcal{F}}
        \newcommand{\calG}{\mathcal{G}}
        \newcommand{\calH}{\mathcal{H}}
        \newcommand{\calI}{\mathcal{I}}
        \newcommand{\calJ}{\mathcal{J}}
        \newcommand{\calK}{\mathcal{K}}
        \newcommand{\calL}{\mathcal{L}}
        \newcommand{\calM}{\mathcal{M}}
        \newcommand{\calN}{\mathcal{N}}
        \newcommand{\calO}{\mathcal{O}}
        \newcommand{\calP}{\mathcal{P}}
        \newcommand{\calQ}{\mathcal{Q}}
        \newcommand{\calR}{\mathcal{R}}
        \newcommand{\calS}{\mathcal{S}}
        \newcommand{\calT}{\mathcal{T}}
        \newcommand{\calU}{\mathcal{U}}
        \newcommand{\calV}{\mathcal{V}}
        \newcommand{\calW}{\mathcal{W}}
        \newcommand{\calX}{\mathcal{X}}
        \newcommand{\calY}{\mathcal{Y}}
        \newcommand{\calZ}{\mathcal{Z}}
    \fi

    %% Provide the same shortcuts for the standard calligraphic and blackboard
    %% fonts.
    \unless\ifjpellis@alphabets@noshort
        \newcommand{\scA}{\textsc{a}}
        \newcommand{\scB}{\textsc{b}}
        \newcommand{\scC}{\textsc{c}}
        \newcommand{\scD}{\textsc{d}}
        \newcommand{\scE}{\textsc{e}}
        \newcommand{\scF}{\textsc{f}}
        \newcommand{\scG}{\textsc{g}}
        \newcommand{\scH}{\textsc{h}}
        \newcommand{\scI}{\textsc{i}}
        \newcommand{\scJ}{\textsc{j}}
        \newcommand{\scK}{\textsc{k}}
        \newcommand{\scL}{\textsc{l}}
        \newcommand{\scM}{\textsc{m}}
        \newcommand{\scN}{\textsc{n}}
        \newcommand{\scO}{\textsc{o}}
        \newcommand{\scP}{\textsc{p}}
        \newcommand{\scQ}{\textsc{q}}
        \newcommand{\scR}{\textsc{r}}
        \newcommand{\scS}{\textsc{s}}
        \newcommand{\scT}{\textsc{t}}
        \newcommand{\scU}{\textsc{u}}
        \newcommand{\scV}{\textsc{v}}
        \newcommand{\scW}{\textsc{w}}
        \newcommand{\scX}{\textsc{x}}
        \newcommand{\scY}{\textsc{y}}
        \newcommand{\scZ}{\textsc{z}}
    \fi
\fi

%% Provide some generic maths shortcuts.  These include:
%%
%% - \e
%%   Shorthand for '\cdot 10^'
%%
%% - \vt, \uv, \ph
%%   For vectors, unit vectors and phasors, displaying them in bold and with the
%%   hat as appropriate.  The unit vectors 'i' and 'j' use the special \imath and
%%   \jmath which do not feature the dot.
%%
%% - \dd
%%   Upright 'd' for derivatives
%%
%% - \st, \pcc, \phc
%%   Shorthand for 'such that', '+ complex conjugate' and '+ Hermitian
%%   conjugate'.  In each case, they are realized as: s.t., + c.c., + h.c.
%%
%% - \pfrac, \ddfrac
%%   Shorthand for complete and partial derivative fractions.  For example
%%   \pfrac{^2 y}{x^2} will result in \frac{\partial^2 y}{x^2}.
%%
%% - \inR, \inZ, \inC, \inQ, \inN Shorthand for 'in reals', 'in integers', 'in
%%   complex', 'in rational', 'in natural'.
%%
%% - \bmtx, \vmtx, \pmtx
%%   Shorthands for the various matrix environments.
\ifjpellis@maths
    %% Provides the exponent shorthand in scientific notation.
    \newcommand{\e}[1]{\cdot 10^{#1}}

    %% Define a poor man's bold.  This is using the poor man's bold
    %% implementation described in the 'bm' package.
    \def\jpellis@pmb#1{{%
            \setbox\tw@\hbox{$\m@th\mkern.4mu$}%
            \mathchoice
            \jpellis@pmb@\displaystyle\@empty{#1}%
            \jpellis@pmb@\textstyle\@empty{#1}%
            \jpellis@pmb@\scriptstyle\defaultscriptratio{#1}%
            \jpellis@pmb@\scriptscriptstyle\defaultscriptscriptratio{#1}}}
    \def\jpellis@pmb@#1#2#3{{%
            \setbox\z@\hbox{$\m@th#1#3$}
            \dimen@#2\wd\tw@
            \dimen@=0.4\dimen@
            \rlap{\copy\z@}
            \kern\dimen@
            \raise1.1\dimen@\rlap{\copy\z@}
            \kern\dimen@
            \rlap{\copy\z@}
            \kern\dimen@
            \raise1.1\dimen@\rlap{\copy\z@}
            \kern\dimen@
            \box\z@}}

    %% Vectors and Unit Vectors
    \RequirePackage{etoolbox}
    \RequirePackage{xstring}
    \def\str@bb{\mathbb}
    \def\str@pzc{\mathpzc}
    \def\str@scr{\mathscr}
    \newcommand{\vt}[1]{%
        \StrExpand[1]{#1}{\str@in}
        \expandarg
        \IfSubStr*{\str@in}{math}{
            % There's an alphabet specified, make sure it's not in our list of
            % manual 'poor man's bold' alphabets
            \IfSubStr*{\str@in}{\str@scr}{
                \jpellis@pmb{#1}
            }{
                \IfSubStr*{\str@in}{\str@pzc}{
                    \jpellis@pmb{#1}
                }{
                    \IfSubStr*{\str@in}{\str@bb}{
                        \jpellis@pmb{#1}
                    }{
                        % None of the alphabets we look for, so use \boldsymbol.
                        \boldsymbol{#1}
                    }
                }
            }
        }{
            % Otherwise, proceed with \boldsymbol
            \boldsymbol{#1}
        }
    }
    \newcommand{\uv}[1]{
        \ifstrequal{#1}{i}{
            \boldsymbol{\hat{\imath}}
        }{
            \ifstrequal{#1}{j}{
                \boldsymbol{\hat{\jmath}}
            }{
                \boldsymbol{\hat{\vt{#1}}}
            }
        }
    }
    \newcommand{\ph}[1]{
        \ifstrequal{#1}{i}{
            \boldsymbol{\tilde{\imath}}
        }{
            \ifstrequal{#1}{j}{
                \boldsymbol{\tilde{\jmath}}
            }{
                \boldsymbol{\tilde{\vt{#1}}}
            }
        }
    }

    %% The upright (roman) 'd' for differential operator and integration
    \newcommand{\dd}{\mathop{}\!\mathrm{d}}
    \def\@ifchevron#1{\@ifnextchar ^{\@firstoftwo{#1}}}
    \def\ddbar{%
      \@ifchevron{\ddbar@opt}{\ddbar@opt{}}%
    }
    \def\ddbar@opt#1#2{\frac{\dd^{#1} #2}{(2\pi)^{#1}}}
    \newcommand{\dD}{\mathop{}\!\mathrm{D}}

    %% Branching franctin
    \DeclareMathOperator{\Br}{Br}

    %% Abbreviation for the `such that', '+c.c' and '+ h.c'
    \newcommand{\st}{\text{ s.t. }}
    \newcommand{\pcc}{+ \mathrm{c.c.}}
    \newcommand{\phc}{+ \mathrm{h.c.}}

    %% A shortcut for partial differentials
    \newcommand{\pfrac}[2]{\frac{\partial{#1}}{\partial{#2}}}
    \newcommand{\ddfrac}[2]{\frac{\dd{#1}}{\dd{#2}}}

    %% Provide in R, in Z, ...
    \newcommand{\inR}{\in\mathbb R}
    \newcommand{\inZ}{\in\mathbb Z}
    \newcommand{\inC}{\in\mathbb C}
    \newcommand{\inQ}{\in\mathbb Q}
    \newcommand{\inN}{\in\mathbb N}
    \newcommand{\inF}{\in\mathbb F}

    %% Provide simpler matrix commands (bmtx and vmtx)
    \newcommand{\bmtx}[1]{\begin{bmatrix}#1\end{bmatrix}}
    \newcommand{\vmtx}[1]{\begin{vmatrix}#1\end{vmatrix}}
    \newcommand{\pmtx}[1]{\begin{pmatrix}#1\end{pmatrix}}
    
\fi

%% Declares the following environments:
%% - Theorem
%% - Lemma
%% - Corollary
%% - Proposition
%% - Postulate
%% - Conjecture
%% - Proof
%% - Definition
%% - Example
\ifjpellis@theorems
    %% Provide a left aligned text
    \newcommand\jpellis@quelle[2]{{%
            \unskip\nobreak\hfil\penalty50
            \hskip2em\hbox{}\nobreak\hfil{#1{#2}}%
            \parfillskip=0pt \finalhyphendemerits=0 \par}}

    \let\openbox\relax
    \RequirePackage{amsthm}
    \RequirePackage{thmtools}
    \RequirePackage{mdframed}
    \RequirePackage{framed}
    % Define theorems, definitions ... environments
    \declaretheoremstyle[
        headfont=\large,
        preheadhook={\begin{mdframed}[
            backgroundcolor=black!10!white,
            innertopmargin=1em,
            splittopskip=\topskip,
            topline=true,
            bottomline=true,
            leftline=false,
            rightline=false]},
        postfoothook=\end{mdframed},
    ]{theoremstyle}
    \declaretheoremstyle[
        headfont=\large,
        preheadhook={\begin{mdframed}[
            backgroundcolor=black!5!white,
            innertopmargin=1em,
            splittopskip=\topskip,
            topline=false,
            bottomline=false,
            leftline=false,
            rightline=false]},
        postfoothook=\end{mdframed},
    ]{lemmastyle}
    \declaretheoremstyle[
        preheadhook={\begin{mdframed}[
            backgroundcolor=white,
            innertopmargin=0.5em,
            splittopskip=\topskip,
            topline=false,
            bottomline=false,
            leftline=true,
            rightline=false]},
        postfoothook=\end{mdframed},
        headformat={\NOTE\ (\NAME)},
        notefont=\normalfont\large\scshape,
        notebraces={}{},
        headpunct={.},
        numbered=no,
        ]{sidestyle}
    \declaretheoremstyle[
        headfont=\normalfont\large\itshape,
        headformat={\NAME\ :},
        bodyfont=\normalfont,
        numbered=no,
        headpunct=,
        qed=\qedsymbol,
        ]{prfstyle}
    \declaretheoremstyle[
        headfont=\normalfont\large\scshape,
        numbered=unless unique,
        bodyfont=\normalfont,
        spaceabove=1em plus 1.5em minus 0.5em,
        prefoothook=\jpellis@quelle{\scshape}{End of Example}
        ]{exmpstyle}

    \declaretheorem[style=theoremstyle,
        refname={theorem,theorems},
        Refname={Theorem,Theorems}]{Theorem}
    \declaretheorem[style=lemmastyle,
        refname={lemma,lemmata},
        Refname={Lemma,Lemmata}]{Lemma}
    \declaretheorem[style=lemmastyle,
        refname={corollary,corollaries},
        Refname={Corollary,Corollaries}]{Corollary}
    \declaretheorem[style=lemmastyle,
        refname={proposition,propositions},
        Refname={Proposition,Propositions}]{Proposition}
    \declaretheorem[style=theoremstyle,
        refname={postulate,postulates},
        Refname={Postulate,Postulates}]{Postulate}
    \declaretheorem[style=theoremstyle,
        refname={conjecture,conjectures},
        Refname={Conjecture,Conjectures}]{Conjecture}
    \declaretheorem[style=prfstyle,
        refname={proof,proofs},
        Refname={Proof,Proofs}]{Proof}
    \declaretheorem[style=sidestyle,name=Defn,
        refname={definition,definitions},
        Refname={Definition,Definitions}]{Definition}
    \declaretheorem[style=exmpstyle,
        refname={example,examples},
        Refname={Example,Examples}]{Example}
\fi

%% Declares a lot of new operators... read below for the list.
\ifjpellis@operators
    \RequirePackage{mathtools}

    %% Additional trigonometric functions
    \DeclareMathOperator{\sech}{sech}
    \DeclareMathOperator{\csch}{csch}
    % \DeclareMathOperator{\coth}{coth} % Already defined
    \DeclareMathOperator{\arcsinh}{arcsinh}
    \DeclareMathOperator{\arccosh}{arccosh}
    \DeclareMathOperator{\arctanh}{arctanh}
    \DeclareMathOperator{\arccsch}{arccsch}
    \DeclareMathOperator{\arcsech}{arcsech}
    \DeclareMathOperator{\arccoth}{arccoth}
    \DeclareMathOperator{\sinc}{sinc}

    % Complex
    \DeclareMathOperator{\Arg}{Arg}
    \DeclareMathOperator{\Log}{Log}

    % Matrices
    \DeclareMathOperator{\Tr}{Tr}
    \DeclareMathOperator{\diag}{diag}
    \def\tr{\mathsf{T}}

    % Special functions
    \DeclareMathOperator{\erf}{erf}
    \DeclareMathOperator{\sign}{sign}
\fi

%% Defines the following delimiters which all come in starred and unstarred
%% flavours, where the starred flavours adjust in size to fit the arguments.
\ifjpellis@delimiters
    \RequirePackage{mathtools}

    \DeclarePairedDelimiter\norm{\lVert}{\rVert}
    \DeclarePairedDelimiter\abs{\lvert}{\rvert}
    \DeclarePairedDelimiter\angles{\langle}{\rangle}
    \DeclarePairedDelimiter\floor{\lfloor}{\rfloor}
    \DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\fi

\RequirePackage{xcolor}
\newcommand\todo[1]{%
    \marginpar[%
      \Huge\vspace{-0.8ex}\hfill%
      \color{red}\(\rightarrow\)%
    ]{%
      \Huge\vspace{-0.8ex}%
      \color{red}\(\leftarrow\)%
    }
    \footnote{\color{red} \bfseries #1}%
}

\endinput